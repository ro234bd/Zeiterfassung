<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teamordination Dr. St√ºtz & Dr. Haselgruber | Zeiterfassung v3.89</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2972/2972531.png">
    
    <script>
      if ('serviceWorker' in navigator) {
        try { navigator.serviceWorker.register('./sw.js').catch(console.log); } catch(e) {}
      }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; font-weight: 800; }
        
        /* Zeilen-Styles f√ºr Tabelle und Kalender */
        .row-holiday { background-color: #fef2f2 !important; color: #991b1b !important; }
        .row-vacation { background-color: #ecfdf5 !important; color: #064e3b !important; }
        .row-schulung { background-color: #f3e8ff !important; color: #6b21a8 !important; } /* VIOLETT */
        .row-custom { background-color: #fffbeb !important; color: #92400e !important; } /* GELB/ORANGE */
        .row-za { background-color: #fff7ed !important; color: #c2410c !important; border-left: 4px solid #f97316 !important; }
        .row-weekend { background-color: #f8fafc !important; color: #64748b !important; }
        .row-sunday { background-color: #fff7ed !important; color: #c2410c !important; border-left: 4px solid #ea580c !important; font-weight: bold !important; }
        .row-school-holiday { background-color: #f0f9ff !important; border-left: 4px solid #0ea5e9 !important; border-bottom: 1px solid #bae6fd !important; }
        
        /* Kalender Grid Anpassungen */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; }
        .cal-day { background: white; min-height: 85px; padding: 4px; font-size: 0.75rem; position: relative; display: flex; flex-direction: column; gap: 2px; }
        .cal-header { background: #f8fafc; font-weight: bold; padding: 8px; text-align: center; font-size: 0.7rem; text-transform: uppercase; }
        
        /* Kalender Eintr√§ge: Standard */
        .cal-entry {
            white-space: normal;      
            word-wrap: break-word;    
            line-height: 1.1;         
            font-size: 0.65rem;       
            padding: 2px 3px;
            border-radius: 3px;
            border: 1px solid transparent;
            font-weight: 600;         
        }

        /* SPEZIAL: Jahresansicht noch kleiner */
        .year-grid .cal-entry {
            font-size: 0.5rem !important;
            line-height: 1.0 !important;
            padding: 1px 2px !important;
        }
        .year-grid .cal-day {
            min-height: 60px !important; /* Etwas kompakter in der H√∂he */
        }

        .year-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        #mainTable { table-layout: fixed; width: 100%; }
        * { font-style: normal; } 

        .sig-box { margin-top: 20px; padding: 20px; border: 2px dashed #cbd5e1; border-radius: 12px; text-align: center; background: #f8fafc; }
        .sig-badge { display: inline-block; padding: 4px 12px; border-radius: 99px; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; }
        .sig-badge.ok { background-color: #22c55e; color: white; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-slate-800">

<div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[9999] flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-8 border-blue-600">
        <h2 class="text-2xl font-black italic uppercase mb-2 text-slate-800">Login <span class="text-blue-600">v3.89</span></h2>
        <p class="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Teamordination Dr. St√ºtz & Dr. Haselgruber</p>
        
        <div id="loginSyncStatus" class="text-[10px] font-bold text-slate-400 uppercase text-center mb-6">‚óè Bereit zum Start</div>

        <div class="space-y-4">
            <div>
                <label class="text-[10px] font-black uppercase text-slate-500">Benutzer</label>
                <select id="loginUserSelect" class="w-full p-3 bg-slate-100 border-2 border-transparent focus:border-blue-500 rounded-xl font-bold outline-none"></select>
            </div>
            <div>
                <label class="text-[10px] font-black uppercase text-slate-500">PIN / Passwort</label>
                <input type="password" id="loginPassInput" placeholder="****" class="w-full p-3 bg-slate-100 border-2 border-transparent focus:border-blue-500 rounded-xl font-bold outline-none text-center text-xl tracking-widest">
            </div>
            <button onclick="performLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-black uppercase shadow-lg transition-all active:scale-95">Anmelden</button>
            <p id="loginErrorMsg" class="text-red-500 text-[10px] font-bold uppercase text-center hidden">Falsches Passwort!</p>
        </div>
        
        <div id="debugLog" class="mt-4 text-[9px] text-slate-300 font-mono text-center"></div>
    </div>
</div>

<div id="teamScheduleOverlay" class="hidden fixed inset-0 bg-black/50 z-[9000] flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-4xl border-t-8 border-blue-500">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h2 class="text-xl font-black italic uppercase text-slate-700">Wochenarbeitszeiten Team</h2>
            <button onclick="document.getElementById('teamScheduleOverlay').classList.add('hidden')" class="text-2xl font-bold text-slate-400 hover:text-red-500">√ó</button>
        </div>
        <p class="text-[10px] text-slate-400 uppercase font-bold mb-4">√úbersicht der Soll-Arbeitszeiten</p>
        <div class="overflow-x-auto">
            <table class="w-full text-xs text-left border-collapse">
                <thead class="bg-slate-100 text-slate-500 font-bold uppercase">
                    <tr>
                        <th class="p-2 border-b">Name</th>
                        <th class="p-2 border-b w-24">Mo</th>
                        <th class="p-2 border-b w-24">Di</th>
                        <th class="p-2 border-b w-24">Mi</th>
                        <th class="p-2 border-b w-24">Do</th>
                        <th class="p-2 border-b w-24">Fr</th>
                    </tr>
                </thead>
                <tbody id="teamScheduleBody" class="divide-y divide-slate-100">
                    </tbody>
            </table>
        </div>
        <button onclick="document.getElementById('teamScheduleOverlay').classList.add('hidden')" class="w-full mt-6 bg-slate-800 text-white py-3 rounded-xl font-bold uppercase text-xs">Schlie√üen</button>
    </div>
</div>

<div class="container mx-auto p-2 md:p-4 max-w-6xl hidden" id="appContainer">
    <header class="bg-white shadow rounded-xl p-4 mb-4 flex flex-wrap justify-between items-center gap-4 border-t-4 border-blue-600">
        <div>
            <h1 class="text-xl font-black italic uppercase tracking-tight">Teamordination <span class="text-blue-600">Dr. St√ºtz & Dr. Haselgruber</span></h1>
            <div id="syncStatus" class="text-[10px] font-bold text-slate-400 uppercase">‚óè Sync wird initialisiert...</div>
        </div>
        <div class="flex items-center gap-4">
            <div id="testHeaderUI" class="hidden flex items-center gap-2 bg-amber-50 p-2 rounded-lg border border-amber-200">
                <input type="datetime-local" id="headerWarpTime" class="text-[10px] p-1 border rounded">
                <button onclick="setHeaderWarp()" class="bg-amber-600 text-white text-[9px] px-2 py-1 rounded font-bold uppercase">Warp</button>
                <button onclick="resetWarp()" class="bg-white text-slate-400 text-[9px] px-2 py-1 rounded font-bold uppercase border">Reset</button>
            </div>
            <div id="liveClock" class="text-2xl font-mono font-bold">00:00:00</div>
            
            <select id="userSelect" onchange="switchUser()" class="bg-slate-100 p-2 rounded font-bold outline-none border-2 border-transparent focus:border-blue-400 hidden"></select>
            
            <button onclick="doLogout()" class="text-xs text-red-500 font-bold uppercase underline ml-2">Abmelden</button>
        </div>
    </header>

    <nav class="flex bg-white shadow rounded-lg mb-4 overflow-hidden no-print">
        <button onclick="showTab('stempeln')" id="btn-stempeln" class="flex-1 py-3 text-xs md:text-sm font-bold tab-active uppercase">Stempeln</button>
        <button onclick="showTab('planung')" id="btn-planung" class="flex-1 py-3 text-xs md:text-sm font-bold uppercase">Urlaub / Kalender</button>
        <button onclick="showTab('uebersicht')" id="btn-uebersicht" class="flex-1 py-3 text-xs md:text-sm font-bold uppercase">Monatsliste</button>
        <button onclick="showTab('einstellungen')" id="btn-einstellungen" class="flex-1 py-3 text-xs md:text-sm font-bold uppercase hidden">Admin</button>
    </nav>

    <section id="tab-stempeln" class="tab-content">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-8 rounded-2xl shadow-lg text-center border">
                <h2 id="displayUserName" class="text-2xl font-black text-slate-700 mb-1">--</h2>
                <p class="text-sm text-slate-400 mb-6" id="displayTodayDate"></p>
                
                <div id="punchButtonsArea">
                    <div class="flex justify-center gap-6 mb-8">
                        <button onclick="punch('in')" class="w-32 h-32 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-xl font-black flex items-center justify-center transition-all active:scale-90 uppercase">Kommen</button>
                        <button onclick="punch('out')" class="w-32 h-32 bg-red-600 hover:bg-red-700 text-white rounded-full shadow-xl font-black flex items-center justify-center transition-all active:scale-90 uppercase">Gehen</button>
                    </div>
                    <div id="todayDetails" class="space-y-2 max-w-xs mx-auto"></div>
                </div>
                
                <div id="adminPunchPlaceholder" class="hidden text-slate-400 font-bold italic border-2 border-dashed border-slate-200 p-8 rounded-xl bg-slate-50">
                    <p>Admin Modus aktiv</p>
                    <p class="text-xs font-normal mt-2">Mitarbeiter oben rechts ausw√§hlen.</p>
                </div>

            </div>
            <div class="bg-white p-6 rounded-2xl shadow border flex flex-col">
                 <h3 class="text-xs font-bold uppercase text-slate-400 mb-4 text-center border-b pb-2">Status & Einstellungen</h3>
                 <div id="punchStatus" class="text-center italic text-slate-500 font-bold mb-4">Bereit...</div>
                 
                 <div class="space-y-4 mt-auto">
                     <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <h4 class="text-[9px] font-black uppercase text-slate-400 mb-2">Passwort √§ndern</h4>
                        <input type="password" id="newPwInput" placeholder="Neues Passwort" class="w-full p-2 border rounded mb-2 text-center text-xs font-bold">
                        <input type="password" id="newPwConfirm" placeholder="Wiederholung" class="w-full p-2 border rounded mb-2 text-center text-xs font-bold">
                        <button onclick="changePassword()" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-600 py-2 rounded font-bold text-[10px] uppercase transition">Speichern</button>
                     </div>

                     <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <h4 class="text-[9px] font-black uppercase text-slate-400 mb-2">Nachricht an Entwickler</h4>
                        <textarea id="devMsgText" placeholder="Bug gefunden? W√ºnsche?" class="w-full p-2 border rounded text-xs h-16 mb-2"></textarea>
                        <button onclick="sendDevMessage()" class="w-full bg-purple-100 text-purple-700 border border-purple-200 py-2 rounded font-bold text-[10px] uppercase hover:bg-purple-200 transition">Senden</button>
                     </div>
                 </div>
            </div>
        </div>
    </section>

    <section id="tab-planung" class="tab-content hidden">
        <div class="bg-white p-4 rounded-xl shadow border mb-4">
            <div id="planStatsBox" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-600 text-white p-4 rounded-xl shadow-md">
                    <p class="text-[10px] uppercase font-bold opacity-80">Aktueller Stundensaldo (heute)</p>
                    <p id="planSaldoDisplay" class="text-3xl font-black italic">0.00h</p>
                </div>
                <div class="bg-emerald-600 text-white p-4 rounded-xl shadow-md">
                    <p class="text-[10px] uppercase font-bold opacity-80">Resturlaub (Tage)</p>
                    <p id="planVacDisplay" class="text-3xl font-black italic">0 Tage</p>
                </div>
                <div class="lg:col-span-2 flex items-center gap-2 bg-slate-50 p-3 rounded-xl border border-dashed border-slate-300">
                    <input type="date" id="planStart" class="p-2 border rounded text-xs font-bold">
                    <span class="text-[10px] font-bold uppercase">bis</span>
                    <input type="date" id="planEnd" class="p-2 border rounded text-xs font-bold">
                    <select id="planType" class="p-2 border rounded text-xs font-bold">
                        <option value="Urlaub">üå¥ Urlaub</option>
                        <option value="Betriebsurlaub">üè¢ Betriebsurlaub (Alle)</option>
                        <option value="Schulung">üéì Schulung (Info)</option>
                        <option value="ZA">‚è≥ Zeitausgleich (ZA)</option>
                        <option value="Krank">ü§í Krank</option>
                        <option value="Sonstiges">‚úèÔ∏è Freitext / Zeit</option>
                        <option value="DELETE">üóëÔ∏è Eintrag l√∂schen (Einzel)</option>
                        <option value="DELETE_ALL" class="text-red-600 font-black">üóëÔ∏è Alle Termine l√∂schen (Zeitraum)</option>
                    </select>
                    <button onclick="addPlanningRange()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold uppercase text-xs">√úbernehmen</button>
                </div>
            </div>

            <div class="flex flex-wrap justify-between items-center gap-4 pt-4 border-t">
                <div class="flex bg-slate-100 p-1 rounded-lg">
                    <button onclick="setCalView('week')" id="v-week" class="px-3 py-1 text-[10px] font-bold uppercase rounded">Woche</button>
                    <button onclick="setCalView('month')" id="v-month" class="px-3 py-1 text-[10px] font-bold uppercase rounded bg-white shadow-sm">Monat</button>
                    <button onclick="setCalView('2month')" id="v-2month" class="px-3 py-1 text-[10px] font-bold uppercase rounded">2-M</button>
                    <button onclick="setCalView('year')" id="v-year" class="px-3 py-1 text-[10px] font-bold uppercase rounded">Jahr</button>
                </div>
                <div class="flex items-center gap-2 bg-slate-50 px-3 py-1 rounded-lg border">
                    <input type="checkbox" id="toggleSchoolHolidays" checked onchange="renderCalendar()" class="w-4 h-4 cursor-pointer">
                    <label for="toggleSchoolHolidays" class="text-[10px] font-bold uppercase text-slate-500 cursor-pointer">Ferien</label>
                    
                    <button onclick="toggleTeamView()" id="btnTeamView" class="ml-4 bg-white border border-emerald-600 text-emerald-600 px-3 py-1 rounded text-[10px] font-black uppercase hover:bg-emerald-50 transition-colors">Team √úbersicht</button>
                    
                    <button onclick="renderTeamSchedule()" class="ml-2 bg-blue-50 border border-blue-600 text-blue-600 px-3 py-1 rounded text-[10px] font-black uppercase hover:bg-blue-100 transition-colors">üìÖ Wer arbeitet wann?</button>
                    
                    <button onclick="fetchSchoolHolidays(true)" title="Daten neu laden" class="ml-2 hover:rotate-180 transition-transform">üîÑ</button>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="changeCalDate(-1)" class="font-bold text-xl">‚óÄ</button>
                    <span id="calCurrentLabel" class="font-black uppercase text-blue-600 min-w-[200px] text-center"></span>
                    <button onclick="changeCalDate(1)" class="font-bold text-xl">‚ñ∂</button>
                </div>
            </div>
        </div>

        <div id="calendarRoot"></div>
    </section>

    <section id="tab-uebersicht" class="tab-content hidden">
        <div class="bg-white shadow rounded-xl border overflow-hidden">
            <div class="p-6 border-b">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-black uppercase italic">Zeitnachweis v3.89</h2>
                        <p class="text-xs text-blue-600 font-bold uppercase tracking-tight">Teamordination Dr. St√ºtz & Dr. Haselgruber</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-bold text-slate-300 uppercase">Mitarbeiter:</p>
                        <p id="billUser" class="text-lg font-black uppercase italic leading-none mb-1">--</p>
                        <p class="text-[9px] font-bold text-slate-300 uppercase">Zeitraum:</p>
                        <p id="billPeriod" class="text-xs font-bold text-slate-400 uppercase leading-none">--</p>
                    </div>
                </div>
                <div id="statGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 text-center">
                    <div><label class="text-[9px] font-bold text-slate-300 uppercase block">Soll/M</label><div id="sumMonthSoll" class="font-black">0</div></div>
                    <div><label class="text-[9px] font-bold text-slate-300 uppercase block">Ist/M</label><div id="sumMonthIst" class="font-black text-blue-600">0</div></div>
                    <div><label class="text-[9px] font-bold text-slate-300 uppercase block">Diff</label><div id="sumMonthDiff" class="font-black">0</div></div>
                    <div><label class="text-[9px] font-bold text-slate-300 uppercase block">Saldo M</label><div id="sumYearSaldo" class="font-black text-blue-800">0</div></div>
                    <div><label class="text-[9px] font-bold text-slate-300 uppercase block">Anspruch</label><div id="sumVacTotal" class="font-black text-green-600">0</div></div>
                    <div><label class="text-[9px] font-bold text-slate-300 uppercase block">Genomm.</label><div id="sumMonthVac" class="font-black">0</div></div>
                    <div><label class="text-[9px] font-bold text-slate-300 uppercase block">Rest</label><div id="sumYearVacRest" class="font-black text-green-700">0</div></div>
                </div>
            </div>
            <div class="p-3 bg-slate-800 text-white flex justify-between items-center no-print">
                <div class="flex gap-2">
                    <select id="viewMonth" onchange="renderLogs()" class="bg-slate-700 p-1 rounded text-xs"></select>
                    <select id="viewYear" onchange="renderLogs()" class="bg-slate-700 p-1 rounded text-xs"></select>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportExcel()" class="bg-emerald-600 px-4 py-1 rounded font-bold text-[10px] uppercase">Excel</button>
                    <button onclick="exportPDF()" class="bg-blue-600 px-4 py-1 rounded font-bold text-[10px] uppercase">PDF Export</button>
                </div>
            </div>
            <table class="w-full text-[11px] text-left" id="mainTable">
                <thead class="bg-slate-50 font-bold uppercase text-slate-500 border-b">
                    <tr>
                        <th class="p-2 w-24">Datum</th>
                        <th class="p-2 w-16 text-right">Kommen</th>
                        <th class="p-2 w-16 text-right">Gehen</th>
                        <th class="p-2 w-24 text-center">Pause</th>
                        <th class="p-2 w-12 text-right">Ist</th>
                        <th class="p-2 w-12 text-right">Soll</th>
                        <th class="p-2 w-14 text-right">Saldo</th>
                        <th class="p-2">Notiz</th>
                        <th class="p-2 no-print text-center w-8"></th>
                    </tr>
                </thead>
                <tbody id="logTableBody"></tbody>
            </table>
            <div id="signatureContainer" class="p-4 flex justify-center no-print"></div>
        </div>
    </section>

    <section id="tab-einstellungen" class="tab-content hidden">
        <div class="bg-white p-6 rounded-xl shadow border mb-6">
            <h2 class="font-black text-purple-600 mb-4 uppercase italic border-b pb-2">System Einstellungen</h2>
            <div class="flex flex-wrap gap-6">
                <label class="flex items-center gap-2 cursor-pointer bg-slate-50 p-2 rounded border">
                    <input type="checkbox" id="checkReserve1" onchange="toggleReserve('Reserve 1')" class="w-4 h-4">
                    <span class="text-xs font-bold uppercase">Reserve 1 anzeigen</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer bg-slate-50 p-2 rounded border">
                    <input type="checkbox" id="checkReserve2" onchange="toggleReserve('Reserve 2')" class="w-4 h-4">
                    <span class="text-xs font-bold uppercase">Reserve 2 anzeigen</span>
                </label>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow border">
                <h2 class="font-black text-blue-600 mb-4 uppercase italic border-b pb-2">Mitarbeiter Stammdaten</h2>
                <div id="adminUserConfig" class="space-y-4"></div>
                <button onclick="saveAdminConfigs()" class="mt-6 bg-blue-600 text-white w-full py-3 rounded-xl font-bold uppercase shadow-lg">Daten speichern</button>
            </div>
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow border">
                    <h2 class="font-black mb-4 uppercase italic border-b pb-2">Soll-Stunden: <span id="targetName" class="text-blue-600"></span></h2>
                    <div id="weeklyEditor" class="space-y-2"></div>
                    <button onclick="saveWeekly()" class="mt-4 bg-slate-800 text-white w-full py-3 rounded-xl font-bold uppercase shadow-lg">Plan speichern</button>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
const CLOUD_URL = "https://script.google.com/macros/s/AKfycbwg3vKEz3JHYX4baAFsL5gyutGFGswoNsXzD8YEZFYVwwMuKP7uc0rbGMyfWua1dfgA/exec";
const DEFAULT_NAMES = ["Michaela Pfoser", "Alexandra Reiter", "Sandra Kehrer", "Annemarie Bruckm√ºller", "Gerlinde Stadler", "Reserve 1", "Reserve 2"];
const WEEKDAYS_SHORT = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"];
const MONTH_NAMES = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
const DB_KEY = 'ze_profi_cloud_v3.86_FINAL'; 

const INITIAL_CONFIG = {
    "Michaela Pfoser": { 1:{start:"00:00",target:0}, 2:{start:"07:30",target:6.5}, 3:{start:"07:00",target:10}, 4:{start:"13:00",target:3.5}, 5:{start:"07:00",target:10} },
    "Alexandra Reiter": { 1:{start:"00:00",target:0}, 2:{start:"07:30",target:6.5}, 3:{start:"07:30",target:6.5}, 4:{start:"13:00",target:7}, 5:{start:"00:00",target:0} },
    "Sandra Kehrer": { 1:{start:"07:30",target:8.5}, 2:{start:"14:00",target:5}, 3:{start:"07:30",target:5.5}, 4:{start:"00:00",target:0}, 5:{start:"07:30",target:7} },
    "Annemarie Bruckm√ºller": { 1:{start:"07:30",target:7}, 2:{start:"07:00",target:7}, 3:{start:"00:00",target:0}, 4:{start:"13:00",target:3.5}, 5:{start:"07:30",target:5.5} },
    "Gerlinde Stadler": { 1:{start:"07:00",target:7}, 2:{start:"14:00",target:5}, 3:{start:"00:00",target:0}, 4:{start:"00:00",target:0}, 5:{start:"00:00",target:0} }
};

let db;
try {
    db = JSON.parse(localStorage.getItem(DB_KEY));
} catch(e) { }

if (!db || !db.users || !Array.isArray(db.users) || db.users.length === 0) {
    db = { users: DEFAULT_NAMES, logs: {}, config: {}, admin: {}, passwords: {} };
    localStorage.setItem(DB_KEY, JSON.stringify(db));
}

let currentUser = db.users[0];
let loggedInUser = null; 
let currentCalDate = new Date();
let calView = 'month';
let timeWarpOffset = 0;
let holidaysDB = {};
let schoolHolidays = [];
let testModeActive = false;
let showTeamView = false; 

const fallbackHolidays = [
    {s: "2026-02-02", e: "2026-02-07", n: "Semesterferien (O√ñ)"},
    {s: "2026-03-28", e: "2026-04-06", n: "Osterferien"},
    {s: "2026-05-23", e: "2026-05-25", n: "Pfingstferien"},
    {s: "2026-07-11", e: "2026-09-13", n: "Sommerferien"},
    {s: "2026-10-26", e: "2026-11-02", n: "Herbstferien"},
    {s: "2026-12-24", e: "2027-01-06", n: "Weihnachtsferien"}
];

function getNow() { return new Date(Date.now() + timeWarpOffset); }
function toLocalISO(date) { 
    let d = new Date(date); 
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'); 
}

function getKulanzStart(tatsZeit, sollBeginn) {
    if(!tatsZeit || !sollBeginn) return tatsZeit;
    const [sH, sM] = sollBeginn.split(':').map(Number);
    const [tH, tM] = tatsZeit.split(':').map(Number);
    const sollMins = sH * 60 + sM;
    const tatsMins = tH * 60 + tM;
    if (Math.abs(tatsMins - sollMins) <= 10) return sollBeginn;
    return tatsZeit;
}

function getVisibleUsers() {
    const activeReserves = db.config.system || { reserve1: false, reserve2: false };
    return db.users.filter(u => {
        if(u === "Reserve 1" && !activeReserves.reserve1) return false;
        if(u === "Reserve 2" && !activeReserves.reserve2) return false;
        return true;
    });
}

function renderTeamSchedule() {
    const tbody = document.getElementById('teamScheduleBody');
    tbody.innerHTML = "";
    const days = [1, 2, 3, 4, 5]; 
    getVisibleUsers().forEach(u => {
        if(u === "Admin") return;
        let rowHtml = `<td class="p-2 font-black text-blue-800 border-b">${u}</td>`;
        days.forEach(d => {
            const cfg = (db.config[u] && db.config[u][d]) ? db.config[u][d] : {start: "08:00", target: 0};
            if(cfg.target > 0) {
                rowHtml += `<td class="p-2 border-b bg-blue-50/50"><div class="font-bold text-xs">${cfg.start}</div><div class="text-[9px] text-slate-400 font-bold">${cfg.target}h</div></td>`;
            } else {
                rowHtml += `<td class="p-2 border-b text-slate-200 text-xs">-</td>`;
            }
        });
        const tr = document.createElement('tr'); tr.innerHTML = rowHtml; tbody.appendChild(tr);
    });
    document.getElementById('teamScheduleOverlay').classList.remove('hidden');
}

function performLogin() {
    const user = document.getElementById('loginUserSelect').value;
    const pass = document.getElementById('loginPassInput').value;
    const storedPass = (db.passwords && db.passwords[user]) ? db.passwords[user] : (user==="Admin"?"Va19tti!":"1234");
    if(pass === storedPass) {
        loggedInUser = user;
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('appContainer').classList.remove('hidden');
        document.getElementById('loginErrorMsg').classList.add('hidden');
        
        if(loggedInUser === "Admin") {
            testModeActive = true;
            document.getElementById('userSelect').classList.remove('hidden');
            document.getElementById('btn-einstellungen').classList.remove('hidden');
            document.getElementById('testHeaderUI').classList.remove('hidden');
            
            currentUser = db.users[0]; 
            const sys = db.config.system || {reserve1: false, reserve2: false};
            document.getElementById('checkReserve1').checked = sys.reserve1;
            document.getElementById('checkReserve2').checked = sys.reserve2;

        } else {
            testModeActive = false;
            document.getElementById('userSelect').classList.add('hidden');
            document.getElementById('btn-einstellungen').classList.add('hidden');
            document.getElementById('testHeaderUI').classList.add('hidden');
            currentUser = loggedInUser;
        }
        
        renderUserSelect();
        document.getElementById('userSelect').value = currentUser;
        renderAll();
    } else {
        document.getElementById('loginErrorMsg').classList.remove('hidden');
    }
}

function doLogout() {
    loggedInUser = null;
    document.getElementById('loginOverlay').classList.remove('hidden');
    document.getElementById('appContainer').classList.add('hidden');
    document.getElementById('loginPassInput').value = "";
}

function getExtendedOutTime(dStr, inStr, outStr) {
    if(!inStr || !outStr) return outStr;
    let calcIn = inStr;
    if(currentUser !== 'Admin') {
         const d = new Date(dStr);
         const cfg = db.config[currentUser][d.getDay()] || {start: "00:00"};
         calcIn = getKulanzStart(inStr, cfg.start);
    }
    const rawIst = (new Date(`${dStr}T${outStr}`) - new Date(`${dStr}T${calcIn}`)) / 3600000;
    if (rawIst > 6.0) {
        let [h, min] = outStr.split(':').map(Number);
        let outDate = new Date(2000, 0, 1, h, min); outDate.setMinutes(outDate.getMinutes() + 30);
        return outDate.getHours().toString().padStart(2, '0') + ":" + outDate.getMinutes().toString().padStart(2, '0');
    }
    return outStr;
}

function getBreakTimeRange(dStr, inStr, outStr, uName) {
    if(!inStr || !outStr) return "-";
    const startD = new Date(`${dStr}T${inStr}`); const endD = new Date(`${dStr}T${outStr}`); const totalHours = (endD - startD) / 3600000;
    let seed = 0; const sStr = dStr + uName; for (let i = 0; i < sStr.length; i++) seed += sStr.charCodeAt(i);
    const randomMinutes = seed % 16;
    let baseOffset = 4.0 + (Math.min(Math.max(totalHours, 6), 11) - 6) * 0.5;
    let breakStart = new Date(startD.getTime() + (baseOffset * 3600000) + (randomMinutes * 60000));
    const fmt = (d) => d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
    let breakEnd = new Date(breakStart.getTime() + 30 * 60000);
    return fmt(breakStart) + " - " + fmt(breakEnd);
}

async function init() {
    try {
        if(!db.users.includes("Admin")) db.users.push("Admin");
        if(!db.passwords) db.passwords = {};
        if(!db.config.system) db.config.system = { reserve1: false, reserve2: false };
        
        db.users.forEach(u => {
            if (!db.config[u]) db.config[u] = {}; 
            if (INITIAL_CONFIG[u]) {
                for(let d=1; d<=5; d++) db.config[u][d] = INITIAL_CONFIG[u][d];
                db.config[u][0] = { start: "00:00", target: 0 };
                db.config[u][6] = { start: "00:00", target: 0 };
            } else {
                for(let d=1; d<=5; d++) if(!db.config[u][d]) db.config[u][d] = { start: "08:00", target: 8 };
            }
            if (!db.admin[u]) db.admin[u] = { startBalance: 0, startDate: "2024-01-01", yearlyVacation: 25, startVacation: 0 };
            if(!db.passwords[u]) { db.passwords[u] = (u === "Admin") ? "Va19tti!" : "1234"; }
        });

        schoolHolidays = [...fallbackHolidays];
        populateSelectors();
        
        const ls = document.getElementById('loginUserSelect'); 
        ls.innerHTML = "";
        getVisibleUsers().forEach(u => { let o = document.createElement('option'); o.value = u; o.innerText = u; ls.appendChild(o); });
        
        if(db.users.includes("Admin") && !getVisibleUsers().includes("Admin")) {
             let o = document.createElement('option'); o.value = "Admin"; o.innerText = "Admin"; ls.appendChild(o);
        }
        
        ls.addEventListener('change', () => document.getElementById('loginPassInput').focus());
        document.getElementById('loginPassInput').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') performLogin();
        });

        updateClock();
        setInterval(updateClock, 1000);

        fetchHolidays();
        fetchSchoolHolidays();
        syncFromCloud();
        
    } catch (err) {
        document.getElementById('debugLog').innerText = "FATAL ERROR: " + err.message;
    }
}

async function syncFromCloud() {
    const statusDiv = document.getElementById('syncStatus');
    const loginSync = document.getElementById('loginSyncStatus');
    try {
        const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 5000); 
        const cleanUrl = CLOUD_URL + "?noCache=" + new Date().getTime();
        const r = await fetch(cleanUrl, { signal: controller.signal });
        clearTimeout(timeoutId);
        
        if(r.ok) {
            const cloudDb = await r.json();
            if(cloudDb && cloudDb.users && Array.isArray(cloudDb.users)) {
                db = cloudDb;
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                statusDiv.innerText = "‚óè Daten geladen"; statusDiv.className = "text-[10px] font-bold text-emerald-600 uppercase";
                if(loginSync) { loginSync.innerText = "‚óè Online (Daten da!)"; loginSync.className = "text-[10px] font-bold text-emerald-600 uppercase text-center mb-6"; }
                renderUserSelect();
                if(loggedInUser) renderAll();
            } 
        }
    } catch(e) { 
        console.log("Offline Modus aktiv");
        statusDiv.innerText = "‚óè Nur lokal (Offline)"; statusDiv.className = "text-[10px] font-bold text-amber-600 uppercase";
        if(loginSync) { loginSync.innerText = "‚óè Offline (Nur lokal)"; loginSync.className = "text-[10px] font-bold text-amber-600 uppercase text-center mb-6"; }
    }
}

async function fetchHolidays() {
    const years = [getNow().getFullYear()-1, getNow().getFullYear(), getNow().getFullYear()+1];
    for(let y of years) {
        try { const r = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${y}/AT`); const d = await r.json(); d.forEach(h => { holidaysDB[h.date] = h.localName; }); holidaysDB[`${y}-05-04`] = "Hl. Florian (O√ñ)"; } catch(e) {}
    }
}

async function fetchSchoolHolidays(manual = false) {
    const start = (getNow().getFullYear()-1) + "-01-01"; const end = (getNow().getFullYear()+2) + "-12-31";
    try { const r = await fetch(`https://openholidaysapi.org/SchoolHolidays?countryCode=AT&subdivisionCode=AT-4&validFrom=${start}&validTo=${end}`); if(r.ok) { const data = await r.json(); if(data && data.length > 0) { schoolHolidays = data.map(f => ({ s: f.startDate, e: f.endDate, n: f.name[0].text })); } } } catch(e) {}
    renderCalendar(); if(manual) alert("Kalenderdaten wurden aktualisiert!");
}

function toggleTeamView() {
    showTeamView = !showTeamView;
    const btn = document.getElementById('btnTeamView');
    if(showTeamView) { btn.classList.add('bg-emerald-600', 'text-white'); btn.classList.remove('bg-white', 'text-emerald-600'); } 
    else { btn.classList.remove('bg-emerald-600', 'text-white'); btn.classList.add('bg-white', 'text-emerald-600'); }
    renderCalendar();
}

function formatDateShort(iso) { const p = iso.split('-'); return `${p[2]}.${p[1]}.`; }

function calculateBalances(userName, targetYear, targetMonth, todayOnly = false) {
    if(userName === 'Admin') return { totalSaldo: 0, restVacation: 0, monthVacation: 0 };
    const admin = db.admin[userName] || {startBalance:0, startDate:"2024-01-01", yearlyVacation:25, startVacation: 0};
    const logs = db.logs[userName] || {};
    let totalSaldo = parseFloat(admin.startBalance) || 0; 
    let usedVacYear = 0, usedVacMonth = 0;
    let iter = new Date(admin.startDate); if(isNaN(iter)) iter = new Date(targetYear, 0, 1);
    let endIter = todayOnly ? getNow() : new Date(targetYear, targetMonth + 1, 0);
    while (iter <= endIter) {
        const dStr = toLocalISO(iter); const log = logs[dStr] || {};
        const isH = holidaysDB[dStr], isWE = iter.getDay()%6==0;
        const target = (isH || isWE) ? 0 : (db.config[userName][iter.getDay()]?.target || 0);
        let ist = 0;
        
        if (log.type === 'Urlaub' || log.type === 'Betriebsurlaub' || log.type === 'Krank') { 
            ist = target; 
            if ((log.type === 'Urlaub' || log.type === 'Betriebsurlaub') && iter.getFullYear() === targetYear && target > 0) { 
                usedVacYear++; 
                if (iter.getMonth() === targetMonth) usedVacMonth++; 
            } 
        } else if (log.type === 'ZA') { ist = 0; }
        else if (log.type === 'Sonstiges') { ist = log.value !== undefined ? parseFloat(log.value) : target; }
        else if (log.in && log.out) {
            if (isWE || isH) { ist = 0; }
            else { 
                let calcIn = log.in;
                const cfg = db.config[userName][iter.getDay()] || {start: "00:00"};
                calcIn = getKulanzStart(log.in, cfg.start);
                ist = (new Date(`${dStr}T${log.out}`) - new Date(`${dStr}T${calcIn}`)) / 3600000; 
                if (ist > 6.0) ist -= 0.5; 
            }
        }
        totalSaldo += (ist - target); iter.setDate(iter.getDate() + 1);
    }
    return { totalSaldo, restVacation: (parseFloat(admin.startVacation || 0) + parseInt(admin.yearlyVacation)) - usedVacYear, monthVacation: usedVacMonth };
}

function renderLogs() {
    const m = parseInt(document.getElementById('viewMonth').value), y = parseInt(document.getElementById('viewYear').value);
    const tbody = document.getElementById('logTableBody'); tbody.innerHTML = "";
    const balancesForMonth = calculateBalances(currentUser, y, m, false), balancesToday = calculateBalances(currentUser, getNow().getFullYear(), getNow().getMonth(), true);
    
    if(currentUser === 'Admin') {
        document.getElementById('statGrid').classList.add('opacity-0');
        document.getElementById('planStatsBox').classList.add('hidden');
    } else {
        document.getElementById('statGrid').classList.remove('opacity-0');
        document.getElementById('planStatsBox').classList.remove('hidden');
    }

    let mIst = 0, mSoll = 0;
    for (let i = 1; i <= new Date(y, m+1, 0).getDate(); i++) {
        const d = new Date(y, m, i), dStr = toLocalISO(d), log = (db.logs[currentUser]||{})[dStr] || {};
        const isH = holidaysDB[dStr], isWE = d.getDay()%6==0, target = (isH || isWE) ? 0 : db.config[currentUser][d.getDay()].target;
        let ist = 0, pauseDisplay = "-", dispOut = log.out || "-";
        
        if (log.type === 'Urlaub' || log.type === 'Betriebsurlaub' || log.type === 'Krank') { 
            ist = target; 
            if(isH || isWE) {
                dispOut = "-";
            } else {
                dispOut = log.type === 'Betriebsurlaub' ? 'Urlaub' : log.type; 
            }
        }
        else if (log.type === 'ZA') { ist = 0; dispOut = "ZA"; }
        else if (log.type === 'Sonstiges') { 
            ist = log.value !== undefined ? parseFloat(log.value) : target;
            dispOut = log.title || "Sonstiges";
        }
        else if (log.type === 'Schulung') {
            // Schulung hat 0h Ist, au√üer man stempelt.
            if(log.in && log.out) {
                 // Fallthrough zu unten (Berechnung durch Stempelung)
            } else {
                 ist = 0; 
                 dispOut = "Schulung"; // Wird in Notiz angezeigt, hier Platzhalter
            }
        }

        // Berechnung √ºberschreiben, falls gestempelt wurde (auch bei Schulung!)
        if (log.in && log.out) {
            let calcIn = log.in;
            const cfg = db.config[currentUser][d.getDay()] || {start: "00:00"};
            if(!isH && !isWE) calcIn = getKulanzStart(log.in, cfg.start);

            const rawIst = (new Date(`${dStr}T${log.out}`) - new Date(`${dStr}T${calcIn}`)) / 3600000;
            if (rawIst > 6.0) { 
                pauseDisplay = getBreakTimeRange(dStr, log.in, log.out, currentUser); 
                dispOut = getExtendedOutTime(dStr, log.in, log.out); 
                ist = (isH || isWE) ? 0 : rawIst - 0.5; 
            } else { 
                ist = (isH || isWE) ? 0 : rawIst; 
            }
        }
        mIst += ist; mSoll += target;
        
        let rowClass = ''; 
        if (log.type==='Urlaub' || log.type==='Betriebsurlaub') rowClass = 'row-vacation';
        else if (log.type==='ZA') rowClass = 'row-za';
        else if (log.type==='Schulung') rowClass = 'row-schulung';
        else if (log.type==='Sonstiges') rowClass = 'row-custom';

        if (d.getDay() === 6) rowClass = 'row-weekend';
        if (d.getDay() === 0) rowClass = 'row-sunday';
        if (isH) rowClass = 'row-holiday';
        
        // Notiz zusammenbauen
        let note = log.note || "";
        if(isH) note = '(' + isH + ') ' + note;
        if(log.type === 'Schulung' && log.range) note = "Schulung: " + log.range + " " + note;
        if(log.type === 'Sonstiges' && log.range) note = log.range + " " + note;
        
        const dateHtml = `<div class="flex items-center"><span class="w-8 text-right font-bold inline-block">${i}.${m+1}.</span><span class="w-10"></span><span class="text-[9px] opacity-60 uppercase tracking-wider">${WEEKDAYS_SHORT[d.getDay()]}</span></div>`;

        tbody.innerHTML += `<tr class="border-b ${rowClass}">
            <td class="p-2 whitespace-nowrap">${dateHtml}</td>
            <td class="p-2 text-right font-medium text-slate-600">${log.in||'-'}</td>
            <td class="p-2 text-right font-medium text-slate-600">${dispOut}</td>
            <td class="p-2 text-center text-slate-600 font-medium">${pauseDisplay}</td>
            <td class="p-2 text-right font-bold">${ist.toFixed(2)}</td><td class="p-2 text-right text-slate-300">${target.toFixed(2)}</td>
            <td class="p-2 text-right font-bold ${(ist-target)<0?'text-red-500':'text-blue-600'}">${(ist-target).toFixed(2)}</td>
            <td class="p-2 text-[10px] text-slate-500 italic truncate">${note}</td>
            <td class="p-2 no-print text-center"><button onclick="editEntry('${dStr}')">‚úèÔ∏è</button></td></tr>`;
    }
    
    if(currentUser !== 'Admin') {
        document.getElementById('sumMonthIst').innerText = mIst.toFixed(2);
        document.getElementById('sumMonthSoll').innerText = mSoll.toFixed(2);
        document.getElementById('sumMonthDiff').innerText = (mIst - mSoll).toFixed(2);
        document.getElementById('sumYearSaldo').innerText = balancesForMonth.totalSaldo.toFixed(2);
        document.getElementById('sumVacTotal').innerText = db.admin[currentUser].yearlyVacation;
        document.getElementById('sumMonthVac').innerText = balancesForMonth.monthVacation;
        document.getElementById('sumYearVacRest').innerText = balancesForMonth.restVacation;
        document.getElementById('planSaldoDisplay').innerText = balancesToday.totalSaldo.toFixed(2) + "h";
        document.getElementById('planVacDisplay').innerText = balancesToday.restVacation + " Tage";
    }

    document.getElementById('billUser').innerText = currentUser;
    document.getElementById('billPeriod').innerText = `${MONTH_NAMES[m]} ${y}`;

    const sigContainer = document.getElementById('signatureContainer');
    if(sigContainer) {
        const key = y + "-" + m;
        const sigData = (db.config[currentUser]?.signatures || {})[key];
        
        if(sigData) {
            let html = `<div class="sig-box bg-green-50 dark:bg-green-900/20 border-green-500"><div class="text-3xl mb-2">‚úÖ</div><div class="text-green-600 dark:text-green-400 font-black text-lg uppercase">Monat abgeschlossen</div><div class="text-sm text-slate-500 dark:text-slate-400 mb-2">Freigegeben: ${new Date(sigData.date).toLocaleString()}</div><span class="sig-badge ok">Signiert</span>`;
            if(loggedInUser === 'Admin') {
                html += `<div class="mt-3 border-t border-green-200 pt-2"><button onclick="resetSignature('${key}')" class="text-[10px] bg-red-100 text-red-600 hover:bg-red-200 px-2 py-1 rounded font-bold uppercase border border-red-200">üîì Reset / Entsperren</button></div>`;
            }
            html += `</div>`;
            sigContainer.innerHTML = html;
        } else {
            if (currentUser !== "Admin") {
                sigContainer.innerHTML = `<div class="sig-box bg-slate-50 dark:bg-slate-800"><h4 class="font-black text-lg mb-2 dark:text-white">Monatsabschluss</h4><p class="text-sm mb-4 text-slate-500">Hiermit best√§tige ich die Richtigkeit aller Zeiten.</p><button onclick="performSignature('${key}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition transform hover:scale-105 uppercase">‚úçÔ∏è Jetzt signieren</button></div>`;
            } else {
                sigContainer.innerHTML = "";
            }
        }
    }
}

async function save() {
    localStorage.setItem(DB_KEY, JSON.stringify(db));
    const statusDiv = document.getElementById('syncStatus');
    const loginSync = document.getElementById('loginSyncStatus');
    try {
        await fetch(CLOUD_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(db) });
        statusDiv.innerText = "‚óè Cloud synchronisiert"; statusDiv.className = "text-[10px] font-bold text-emerald-600 uppercase";
        if(loginSync) { loginSync.innerText = "‚óè Online (Verbunden)"; loginSync.className = "text-[10px] font-bold text-emerald-600 uppercase text-center mb-6"; }
    } catch(e) { 
        statusDiv.innerText = "‚óè Nur lokal (Offline)"; statusDiv.className = "text-[10px] font-bold text-amber-600 uppercase"; 
        if(loginSync) { loginSync.innerText = "‚óè Offline (Nur lokal)"; loginSync.className = "text-[10px] font-bold text-amber-600 uppercase text-center mb-6"; }
    }
}

function generateMonthNode(y, m, mini = false) {
    const wrap = document.createElement('div'); wrap.className = "mb-8 bg-white p-4 rounded-xl border shadow-sm";
    wrap.innerHTML = `<h4 class="font-black uppercase text-xs mb-2 text-blue-600 border-b pb-1">${MONTH_NAMES[m]} ${y}</h4>`;
    const grid = document.createElement('div'); grid.className = "cal-grid";
    ["M", "D", "M", "D", "F", "S", "S"].forEach(d => { grid.innerHTML += `<div class="cal-header">${d}</div>`; });
    const first = new Date(y, m, 1), offset = (first.getDay() === 0 ? 6 : first.getDay() - 1), last = new Date(y, m + 1, 0).getDate();
    const showFerien = document.getElementById('toggleSchoolHolidays')?.checked ?? true;
    for(let i=0; i<offset+last; i++) {
        const cell = document.createElement('div'); cell.className = `cal-day border ${mini?'min-h-[60px]':''}`;
        if(i >= offset) {
            const day = i - offset + 1, d = new Date(y, m, day), dStr = toLocalISO(d);
            const isH = holidaysDB[dStr], isF = schoolHolidays.find(f => dStr >= f.s && dStr <= f.e);
            cell.innerHTML = `<b>${day}</b>`;
            
            if(isH) { 
                cell.classList.add('row-holiday'); cell.innerHTML += `<div class='text-[7px] leading-tight'>${isH}</div>`; 
            } else if(d.getDay() === 6) { 
                cell.classList.add('row-weekend'); 
            } else if(d.getDay() === 0) { 
                cell.classList.add('row-sunday'); 
            } else if(isF && showFerien) { 
                cell.classList.add('row-school-holiday'); if(dStr === isF.s) cell.innerHTML += `<div class='text-[7px] text-blue-500 font-black mt-1 leading-none uppercase'>${isF.n}</div>`; 
            }
            
            if(showTeamView) {
                getVisibleUsers().forEach(u => {
                    if (u === "Admin") return;
                    const uLog = (db.logs[u]||{})[dStr] || {};
                    if(uLog.type) {
                        // --- Urlaub nur anzeigen, wenn Arbeitstag ---
                        const typesToHide = ['Urlaub', 'Betriebsurlaub', 'Krank', 'ZA'];
                        if (typesToHide.includes(uLog.type)) {
                            const dayOfWeek = d.getDay();
                            const target = (db.config[u] && db.config[u][dayOfWeek]) ? db.config[u][dayOfWeek].target : 0;
                            if (dayOfWeek === 0 || dayOfWeek === 6 || isH || target === 0) return;
                        }
                        // ---------------------------------------------------------
                        let cl = "bg-blue-50 text-blue-700 border-blue-200"; 
                        if(uLog.type==='Urlaub' || uLog.type==='Betriebsurlaub') cl="bg-emerald-50 text-emerald-700 border-emerald-200"; 
                        if(uLog.type==='Schulung') cl="bg-purple-100 text-purple-700 border-purple-200";
                        if(uLog.type==='Sonstiges') cl="bg-yellow-50 text-yellow-700 border-yellow-200";

                        let label = u.split(' ')[0];
                        if(uLog.type==='Schulung' && uLog.range) label += ` (${uLog.range})`;
                        else if(uLog.type==='Sonstiges' && uLog.title) {
                            label += ` (${uLog.title}`;
                            if(uLog.range) label += `, ${uLog.range}`;
                            label += `)`;
                        }
                        else if(uLog.type!=='Urlaub'&&uLog.type!=='Betriebsurlaub') label += `: ${uLog.type}`;
                        
                        // Hier wird die "cal-entry" Klasse verwendet, die wir im n√§chsten Schritt CSS-seitig verbessern
                        cell.innerHTML += `<div class='cal-entry ${cl}'>${label}</div>`;
                    }
                });
            } else {
                const log = (db.logs[currentUser]||{})[dStr] || {};
                if(log && log.type) { 
                    // --- Urlaub nur anzeigen, wenn Arbeitstag ---
                    let showLog = true;
                    const typesToHide = ['Urlaub', 'Betriebsurlaub', 'Krank', 'ZA'];
                    if (typesToHide.includes(log.type)) {
                         const dayOfWeek = d.getDay();
                         const target = (db.config[currentUser] && db.config[currentUser][dayOfWeek]) ? db.config[currentUser][dayOfWeek].target : 0;
                         if (dayOfWeek === 0 || dayOfWeek === 6 || isH || target === 0) showLog = false;
                    }
                    // ---------------------------------------------------------

                    if(showLog) {
                        if(!isH && d.getDay() !== 6 && d.getDay() !== 0) {
                            if(log.type==='Urlaub' || log.type==='Betriebsurlaub') cell.classList.add('row-vacation'); 
                            else if(log.type==='ZA') cell.classList.add('row-za'); 
                            else if(log.type==='Schulung') cell.classList.add('row-schulung');
                            else if(log.type==='Sonstiges') cell.classList.add('row-custom');
                            else cell.classList.add('bg-amber-50'); 
                        }
                        let txt = log.type === 'Betriebsurlaub' ? 'Urlaub' : log.type;
                        if(log.type === 'Sonstiges' && log.title) txt = log.title;
                        if(log.type === 'Schulung' && log.range) txt = "Schulung (" + log.range + ")";
                        
                        cell.innerHTML += `<div class='cal-entry'>${txt}</div>`; 
                    }
                }
            }
        } else cell.classList.add('bg-slate-50');
        grid.appendChild(cell);
    }
    wrap.appendChild(grid); return wrap;
}

function setCalView(v) { calView = v; renderCalendar(); }
function changeCalDate(dir) {
    if(calView === 'week') currentCalDate.setDate(currentCalDate.getDate() + (dir * 7));
    else if(calView === 'year') currentCalDate.setFullYear(currentCalDate.getFullYear() + dir);
    else currentCalDate.setMonth(currentCalDate.getMonth() + dir);
    renderCalendar();
}

function renderCalendar() {
    const root = document.getElementById('calendarRoot'); root.innerHTML = "";
    const y = currentCalDate.getFullYear(), m = currentCalDate.getMonth();
    ['week','month','2month','year'].forEach(v => { const btn = document.getElementById('v-'+v); if(btn) { if(v === calView) { btn.classList.add('bg-white', 'shadow-sm'); } else { btn.classList.remove('bg-white', 'shadow-sm'); } } });
    if(calView === 'year') {
        document.getElementById('calCurrentLabel').innerText = "Jahr " + y; const container = document.createElement('div'); container.className = "year-grid";
        for(let i=0; i<12; i++) container.appendChild(generateMonthNode(y, i, true)); root.appendChild(container);
    } else if(calView === '2month') {
        document.getElementById('calCurrentLabel').innerText = "Vorschau 2 Monate"; root.appendChild(generateMonthNode(y, m));
        let nm = m+1, ny = y; if(nm>11){nm=0; ny++;} root.appendChild(generateMonthNode(ny, nm));
    } else if(calView === 'month') {
        document.getElementById('calCurrentLabel').innerText = MONTH_NAMES[m] + " " + y; root.appendChild(generateMonthNode(y, m));
    } else {
        let start = new Date(currentCalDate); let diff = start.getDay() === 0 ? 6 : start.getDay() - 1; start.setDate(start.getDate() - diff);
        document.getElementById('calCurrentLabel').innerText = "Woche " + start.getDate() + "." + (start.getMonth()+1) + ".";
        const grid = document.createElement('div'); grid.className = "grid grid-cols-1 md:grid-cols-7 gap-2";
        for(let i=0; i<7; i++) {
            const d = new Date(start); d.setDate(d.getDate() + i); const dStr = toLocalISO(d); const isH = holidaysDB[dStr];
            let content = `<p class="text-[9px] uppercase font-bold text-slate-400">${WEEKDAYS_SHORT[d.getDay()]}</p><p class="text-xl font-black">${d.getDate()}.${d.getMonth()+1}.</p>`;
            if(showTeamView) {
                getVisibleUsers().forEach(u => {
                    if (u === "Admin") return;
                    const uLog = (db.logs[u]||{})[dStr] || {};
                    if(uLog.type) { 
                        // --- NEUE LOGIK: Urlaub nur anzeigen, wenn Arbeitstag ---
                        const typesToHide = ['Urlaub', 'Betriebsurlaub', 'Krank', 'ZA'];
                        if (typesToHide.includes(uLog.type)) {
                            const dayOfWeek = d.getDay();
                            const target = (db.config[u] && db.config[u][dayOfWeek]) ? db.config[u][dayOfWeek].target : 0;
                            if (dayOfWeek === 0 || dayOfWeek === 6 || isH || target === 0) return;
                        }
                        // ---------------------------------------------------------
                        let col = "text-blue-700 bg-blue-50"; 
                        if(uLog.type==='Urlaub' || uLog.type==='Betriebsurlaub') col="text-emerald-700 bg-emerald-50"; 
                        if(uLog.type==='Schulung') col="text-purple-700 bg-purple-50";
                        if(uLog.type==='Sonstiges') col="text-yellow-700 bg-yellow-50";
                        
                        let txt = u.split(' ')[0];
                        if(uLog.type==='Schulung' && uLog.range) txt += ` (${uLog.range})`;
                        else if(uLog.type==='Sonstiges' && uLog.title) {
                            txt += ` (${uLog.title}`;
                            if(uLog.range) txt += `, ${uLog.range}`;
                            txt += `)`;
                        }
                        else if(uLog.type!=='Urlaub'&&uLog.type!=='Betriebsurlaub') txt += `: ${uLog.type}`;
                        
                        content += `<div class='text-[8px] font-bold ${col} p-1 rounded mt-1 border truncate'>${txt}</div>`; 
                    }
                });
            } else {
                const log = (db.logs[currentUser]||{})[dStr] || {};
                let dt = (log.in ? log.in + ' - ' + (getExtendedOutTime(dStr, log.in, log.out) || '') : '');
                
                // --- NEUE LOGIK ---
                let typeDisplay = log.type === 'Betriebsurlaub' ? 'Urlaub' : log.type;
                if(log.type === 'Sonstiges' && log.title) typeDisplay = log.title;
                if(log.type === 'Schulung' && log.range) typeDisplay = "Schulung (" + log.range + ")";

                const typesToHide = ['Urlaub', 'Betriebsurlaub', 'Krank', 'ZA'];
                if (typesToHide.includes(log.type)) {
                     const dayOfWeek = d.getDay();
                     const target = (db.config[currentUser] && db.config[currentUser][dayOfWeek]) ? db.config[currentUser][dayOfWeek].target : 0;
                     if (dayOfWeek === 0 || dayOfWeek === 6 || isH || target === 0) typeDisplay = "";
                }
                // ---------------------------------------------------------
                
                content += `<p class="text-[10px] mt-2 font-bold text-blue-600 truncate">${isH || typeDisplay || dt}</p>`;
            }
            grid.innerHTML += `<div class="p-4 bg-white border rounded-xl shadow-sm ${isH?'row-holiday':''}">${content}</div>`;
        }
        root.appendChild(grid);
    }
}

function updateClock() { const n = getNow(); document.getElementById('liveClock').innerText = n.toLocaleTimeString('de-DE'); document.getElementById('displayTodayDate').innerText = n.toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'long'}); }
function punch(t) {
    if (currentUser === "Admin") return; 
    const n = getNow(), ds = toLocalISO(n);
    let ts = n.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});

    // DIREKTE KULANZ-KORREKTUR VOR DEM SPEICHERN
    const isWE = n.getDay() === 0 || n.getDay() === 6;
    const isH = holidaysDB[ds];
    if (t === 'in' && !isWE && !isH) {
        const config = (db.config[currentUser] && db.config[currentUser][n.getDay()]) ? db.config[currentUser][n.getDay()] : {start:"00:00"};
        ts = getKulanzStart(ts, config.start);
    }

    if(!db.logs[currentUser]) db.logs[currentUser] = {}; if(t==='in') db.logs[currentUser][ds] = {in:ts, out:null}; else if(db.logs[currentUser][ds]) db.logs[currentUser][ds].out=ts; save(); renderAll();
}
function switchUser() { 
    if(loggedInUser !== "Admin") return; 
    currentUser = document.getElementById('userSelect').value; 
    document.getElementById('displayUserName').innerText = currentUser; document.getElementById('targetName').innerText = currentUser; renderAll(); 
}
function renderAll() { 
    if(currentUser === 'Admin') {
        document.getElementById('punchButtonsArea').classList.add('hidden');
        document.getElementById('adminPunchPlaceholder').classList.remove('hidden');
        document.getElementById('todayDetails').innerHTML = "";
    } else {
        document.getElementById('punchButtonsArea').classList.remove('hidden');
        document.getElementById('adminPunchPlaceholder').classList.add('hidden');
        renderTodayInfo();
    }

    renderLogs(); renderCalendar(); renderWeeklySettings(); renderAdminConfigs(); 
}
function showTab(id) { document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active')); document.getElementById('tab-'+id).classList.remove('hidden'); document.getElementById('btn-'+id).classList.add('tab-active'); renderAll(); }
function populateSelectors() {
    const sm = document.getElementById('viewMonth'), sy = document.getElementById('viewYear'), n = getNow(); sm.innerHTML = ""; sy.innerHTML = "";
    for(let i=0; i<12; i++) { let o = document.createElement('option'); o.value = i; o.innerText = MONTH_NAMES[i]; o.selected = i === n.getMonth(); sm.appendChild(o); }
    for(let i=2024; i<=2027; i++) { let o = document.createElement('option'); o.value = i; o.innerText = i; o.selected = i === n.getFullYear(); sy.appendChild(o); }
}
function renderUserSelect() { 
    const s = document.getElementById('userSelect'); s.innerHTML = ""; 
    getVisibleUsers().forEach(u => { let o = document.createElement('option'); o.value = u; o.innerText = u; s.appendChild(o); }); 
}
function renderWeeklySettings() {
    const cont = document.getElementById('weeklyEditor'); cont.innerHTML = "";
    if (currentUser === "Admin") { cont.innerHTML = "<p class='text-xs italic text-slate-400'>Admin hat keine Arbeitszeiten.</p>"; return; }
    for(let i=1; i<=5; i++) { const c = db.config[currentUser][i] || {start:"08:00", target:8}; cont.innerHTML += `<div class="flex items-center gap-2 p-3 bg-slate-50 rounded-lg border italic"><span class="w-24 font-bold text-xs uppercase">${WEEKDAYS_SHORT[i]}</span><input type="time" id="ws_${i}" value="${c.start}" class="border p-1 rounded text-xs"><input type="number" id="wt_${i}" value="${c.target}" step="0.5" class="border p-1 rounded w-16 text-right text-xs font-black"> h</div>`; }
}
function saveWeekly() { 
    if(currentUser==="Admin") return;
    for(let i=1; i<=5; i++) { db.config[currentUser][i] = { start: document.getElementById('ws_'+i).value, target: parseFloat(document.getElementById('wt_'+i).value) || 0 }; } save(); alert("Plan gespeichert!"); renderAll(); 
}

function addPlanningRange() {
    const start = document.getElementById('planStart').value, end = document.getElementById('planEnd').value, type = document.getElementById('planType').value;
    if(start) {
        let current = new Date(start), finish = end ? new Date(end) : new Date(start);
        
        let customTitle = null, customValue = null, customRange = null, schulungRange = null;
        let forAll = false;

        if(type === 'Sonstiges') {
            customTitle = prompt("Titel f√ºr den Eintrag (z.B. Teamsitzung):");
            if(!customTitle) return;
            customRange = prompt("Zeitraum (z.B. 12:00 - 14:00) - Optional:", "");
            customValue = prompt("Stundenanzahl (Optional - leer lassen f√ºr Tagessoll):", "");
            if(confirm("Soll dieser Eintrag f√ºr ALLE Mitarbeiter gelten?\nOK = Ja, f√ºr alle\nAbbrechen = Nein, nur f√ºr " + currentUser)) {
                forAll = true;
            }
        }
        if(type === 'Schulung') {
            schulungRange = prompt("Zeitraum (z.B. 09:00 - 12:00):");
            if(!schulungRange) return;
            if(confirm("Soll diese Schulung f√ºr ALLE Mitarbeiter gelten?\nOK = Ja, f√ºr alle\nAbbrechen = Nein, nur f√ºr " + currentUser)) {
                forAll = true;
            }
        }

        let targets = [currentUser];
        if(type === 'Betriebsurlaub' || type === 'DELETE_BU' || type === 'DELETE_ALL' || forAll) {
            targets = getVisibleUsers().filter(u => u !== 'Admin');
        } else if (currentUser === 'Admin' && !forAll) {
            alert("Admin hat keine Urlaubsfunktion."); return;
        }

        while(current <= finish) { 
            const dIso = toLocalISO(current);
            targets.forEach(u => {
                if(!db.logs[u]) db.logs[u] = {}; 
                
                if(type === 'DELETE_BU') {
                    if(db.logs[u][dIso]?.type === 'Betriebsurlaub') delete db.logs[u][dIso];
                } else if(type === "DELETE") {
                    delete db.logs[u][dIso]; 
                } else if(type === "DELETE_ALL") {
                    // L√∂scht jeglichen Eintrag an diesem Tag
                     if(db.logs[u][dIso]) delete db.logs[u][dIso];
                } else {
                    let entry = db.logs[u][dIso] || {};
                    entry.type = type;
                    
                    if(type === 'Sonstiges') {
                        entry.title = customTitle;
                        if(customValue !== "") entry.value = customValue;
                        if(customRange !== "") entry.range = customRange;
                    }
                    if(type === 'Schulung') {
                        entry.range = schulungRange;
                    }
                    db.logs[u][dIso] = entry; 
                }
            });
            current.setDate(current.getDate() + 1); 
        }
        save(); renderAll();
        if(type === 'Betriebsurlaub') alert("Betriebsurlaub f√ºr alle Mitarbeiter eingetragen!");
        if(type === 'DELETE_ALL') alert("Alle Termine im Zeitraum gel√∂scht.");
        if(forAll) alert("Eintrag '" + (customTitle || "Schulung") + "' wurde f√ºr ALLE Mitarbeiter erstellt.");
    }
}

function renderTodayInfo() { 
    if(currentUser === 'Admin') return;
    const ds = toLocalISO(getNow()), log = (db.logs[currentUser]||{})[ds] || {in:'--', out:null}; 
    let dispOut = log.out ? getExtendedOutTime(ds, log.in, log.out) : '--:--';
    document.getElementById('todayDetails').innerHTML = `<div class="flex justify-between p-2 bg-green-50 rounded border text-xs italic"><span>KOMMEN:</span><span class="font-black">${log.in || '--:--'}</span></div><div class="flex justify-between p-2 bg-red-50 rounded border text-xs italic"><span>GEHEN:</span><span class="font-black">${dispOut}</span></div>`; 
}
function editEntry(d) {
    if(currentUser === "Admin") return alert("Admin kann nicht stempeln.");
    const log = (db.logs[currentUser]||{})[d] || {in:'', out:'', note:''};
    const ni = prompt("Kommen (HH:MM) - Leer lassen zum L√∂schen:", log.in);
    if(ni === "") { if(confirm("Eintrag f√ºr " + d + " wirklich l√∂schen?")) { delete db.logs[currentUser][d]; save(); renderAll(); return; } }
    const no = prompt("Gehen (HH:MM):", log.out); const nn = prompt("Notiz:", log.note || "");
    if(ni!==null) { if(!db.logs[currentUser]) db.logs[currentUser] = {}; db.logs[currentUser][d] = {in:ni, out:no, note:nn}; save(); renderAll(); }
}

function setHeaderWarp() { const val = document.getElementById('headerWarpTime').value; if(val) { timeWarpOffset = new Date(val).getTime() - Date.now(); renderAll(); alert("Warp aktiv!"); } }
function resetWarp() { timeWarpOffset = 0; document.getElementById('headerWarpTime').value = ""; alert("Zeit zur√ºckgesetzt."); renderAll(); }
function performSignature(key) {
    if(!confirm("Monat wirklich signieren?")) return;
    if(!db.config[currentUser]) db.config[currentUser] = {}; if(!db.config[currentUser].signatures) db.config[currentUser].signatures = {};
    db.config[currentUser].signatures[key] = { signed: true, date: new Date().toISOString() };
    save(); renderLogs();
}
function resetSignature(key) {
    if(!confirm("Signatur wirklich entfernen? Der Monat ist dann wieder offen.")) return;
    if(db.config[currentUser]?.signatures?.[key]) {
        delete db.config[currentUser].signatures[key];
        save(); renderLogs();
    }
}

function changePassword() {
    const newPw = document.getElementById('newPwInput').value; 
    const confirmPw = document.getElementById('newPwConfirm').value;
    
    if(newPw.length < 4) return alert("Passwort muss mindestens 4 Zeichen haben!");
    if(newPw !== confirmPw) return alert("Passw√∂rter stimmen nicht √ºberein!");
    
    if(!db.passwords) db.passwords = {}; db.passwords[currentUser] = newPw; save(); 
    alert("Passwort erfolgreich ge√§ndert!");
    document.getElementById('newPwInput').value = "";
    document.getElementById('newPwConfirm').value = "";
}
function sendDevMessage() {
    const txt = document.getElementById('devMsgText').value; if(!txt) return;
    if(!db.messages) db.messages = []; db.messages.push({from: currentUser, date: new Date().toISOString(), text: txt}); save(); alert("Gesendet!");
}

function toggleReserve(rName) {
    if(loggedInUser !== "Admin") return;
    const key = rName === "Reserve 1" ? "reserve1" : "reserve2";
    if(!db.config.system) db.config.system = {reserve1: false, reserve2: false};
    db.config.system[key] = document.getElementById(rName === "Reserve 1" ? "checkReserve1" : "checkReserve2").checked;
    save();
    
    const ls = document.getElementById('loginUserSelect'); ls.innerHTML = "";
    getVisibleUsers().forEach(u => { let o = document.createElement('option'); o.value = u; o.innerText = u; ls.appendChild(o); });
    if(db.users.includes("Admin") && !getVisibleUsers().includes("Admin")) {
         let o = document.createElement('option'); o.value = "Admin"; o.innerText = "Admin"; ls.appendChild(o);
    }
    renderUserSelect();
    renderAll();
}

function renderAdminConfigs() {
    if(loggedInUser !== "Admin") { document.getElementById('adminUserConfig').innerHTML = "<p>Zugriff verweigert.</p>"; return; }
    
    const selectedEditUser = currentUser;
    if(!selectedEditUser) return;

    const cont = document.getElementById('adminUserConfig'); 
    cont.innerHTML = "";
    
    const idx = db.users.indexOf(selectedEditUser); 
    const a = db.admin[selectedEditUser] || {startDate: "2024-01-01", startBalance:0, yearlyVacation:25, startVacation: 0};
    
    cont.innerHTML = `<div class="p-4 bg-slate-50 rounded-xl border mb-2 border-blue-200 shadow-inner">
        ${testModeActive ? `<label class="text-[9px] font-bold text-slate-400 uppercase">Name bearbeiten:</label><input type="text" id="nameEdit_SINGLE" value="${selectedEditUser}" class="w-full mb-2 p-1 border rounded font-black text-blue-600 uppercase text-xs italic">` : `<p class="font-black text-blue-800 text-xs mb-2 uppercase italic">${selectedEditUser}</p>`}
        
        <div class="grid grid-cols-2 gap-2 text-[8px] font-bold text-slate-400 uppercase mb-1"><span>Start-Datum</span><span>Zeitsaldo Alt (h)</span></div>
        <div class="grid grid-cols-2 gap-2 mb-2"><input type="date" id="admDate_SINGLE" value="${a.startDate}" class="p-2 border rounded text-xs font-bold"><input type="number" step="0.01" id="admBal_SINGLE" value="${a.startBalance}" class="p-2 border rounded text-xs font-bold"></div>
        
        <div class="grid grid-cols-2 gap-2 text-[8px] font-bold text-slate-400 uppercase mb-1"><span>Urlaub Alt (Tage)</span><span>Urlaub / Jahr</span></div>
        <div class="grid grid-cols-2 gap-2"><input type="number" id="admVacAlt_SINGLE" value="${a.startVacation || 0}" class="p-2 border rounded text-xs font-bold"><input type="number" id="admVacJ_SINGLE" value="${a.yearlyVacation}" class="p-2 border rounded text-xs font-bold"></div>
        
        <div class="mt-4 pt-4 border-t border-slate-200">
            <div class="text-[8px] font-bold text-slate-400 uppercase">PIN Reset</div>
            <button onclick="db.passwords['${selectedEditUser}']='1234';save();alert('PIN f√ºr ${selectedEditUser} auf 1234 gesetzt.');" class="bg-red-100 text-red-500 hover:bg-red-200 px-3 py-2 rounded text-[9px] mt-1 font-bold w-full">PIN auf 1234 zur√ºcksetzen</button>
        </div>
    </div>`;
}

function saveAdminConfigs() {
    const selectedEditUser = currentUser; 
    if(!selectedEditUser) return;
    
    let newName = testModeActive ? document.getElementById(`nameEdit_SINGLE`).value.trim() : selectedEditUser;
    
    if(newName !== selectedEditUser) {
        const idx = db.users.indexOf(selectedEditUser);
        if(idx !== -1) db.users[idx] = newName;
        db.logs[newName] = db.logs[selectedEditUser]; delete db.logs[selectedEditUser];
        db.config[newName] = db.config[selectedEditUser]; delete db.config[selectedEditUser];
        db.passwords[newName] = db.passwords[selectedEditUser]; delete db.passwords[selectedEditUser];
        
        db.admin[newName] = { startDate: document.getElementById(`admDate_SINGLE`).value, startBalance: parseFloat(document.getElementById(`admBal_SINGLE`).value) || 0, startVacation: parseFloat(document.getElementById(`admVacAlt_SINGLE`).value) || 0, yearlyVacation: parseInt(document.getElementById(`admVacJ_SINGLE`).value) || 25 };
        delete db.admin[selectedEditUser];
        
        alert(`Benutzer ${selectedEditUser} wurde in ${newName} umbenannt.`);
        
        currentUser = newName;
        renderUserSelect();
        document.getElementById('userSelect').value = newName;
    } else {
        db.admin[selectedEditUser] = { startDate: document.getElementById(`admDate_SINGLE`).value, startBalance: parseFloat(document.getElementById(`admBal_SINGLE`).value) || 0, startVacation: parseFloat(document.getElementById(`admVacAlt_SINGLE`).value) || 0, yearlyVacation: parseInt(document.getElementById(`admVacJ_SINGLE`).value) || 25 };
    }
    
    save(); alert("Daten gespeichert!"); renderAll();
}

async function exportPDF() { 
    try {
        const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4'); const m = parseInt(document.getElementById('viewMonth').value), y = parseInt(document.getElementById('viewYear').value); const balances = calculateBalances(currentUser, y, m, false);
        doc.setFontSize(16); doc.setFont(undefined, 'bold'); doc.setTextColor(30, 41, 59); doc.text("Zeitnachweis", 14, 15); doc.setFontSize(8); doc.setTextColor(37, 99, 235); doc.text("Teamordination Dr. St√ºtz & Dr. Haselgruber", 14, 20); doc.setTextColor(148, 163, 184); doc.setFontSize(7); doc.text("MITARBEITER", 196, 15, { align: "right" }); doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.setTextColor(30, 41, 59); doc.text(currentUser.toUpperCase(), 196, 20, { align: "right" }); doc.setFontSize(7); doc.setTextColor(148, 163, 184); doc.text("ZEITRAUM", 196, 26, { align: "right" }); doc.setFontSize(8); doc.setTextColor(30, 41, 59); doc.text(`${MONTH_NAMES[m]} ${y}`, 196, 31, { align: "right" });
        doc.autoTable({ html: '#mainTable', startY: 38, theme: 'striped', alternateRowStyles: { fillColor: [240, 247, 255] }, headStyles: { fillColor: [37, 99, 235], textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 8, halign: 'center' }, styles: { fontSize: 7.5, cellPadding: 1.2, textColor: [51, 65, 85], valign: 'middle' }, columnStyles: { 0: { cellWidth: 22, fontStyle: 'bold' }, 1: { cellWidth: 16, halign: 'right' }, 2: { cellWidth: 16, halign: 'right' }, 3: { cellWidth: 24, halign: 'center'}, 4: { cellWidth: 14, halign: 'right', fontStyle: 'bold' }, 5: { cellWidth: 14, halign: 'right' }, 6: { cellWidth: 16, halign: 'right', fontStyle: 'bold' }, 7: { halign: 'left' } }, columns: [0, 1, 2, 3, 4, 5, 6, 7],
            didParseCell: function(data) { 
                if (data.section === 'body') { 
                    const text = data.cell.raw.innerText || ""; const row = data.row.index + 1; const dStr = y + '-' + String(m + 1).padStart(2, '0') + '-' + String(row).padStart(2, '0');
                    if (holidaysDB[dStr]) { data.cell.styles.fillColor = [254, 242, 242]; data.cell.styles.textColor = [153, 27, 27]; }
                    else if (new Date(y, m, row).getDay() === 0) { data.cell.styles.fillColor = [255, 247, 237]; }
                    if (text.includes("Urlaub") || text.includes("Betriebsurlaub")) { data.cell.styles.fillColor = [209, 250, 229]; data.cell.styles.textColor = [6, 78, 59]; } 
                    else if (text.includes("Krank")) { data.cell.styles.fillColor = [254, 243, 199]; } 
                    else if (text.includes("ZA")) { data.cell.styles.fillColor = [255, 237, 213]; data.cell.styles.textColor = [154, 52, 18]; } 
                } 
            }
        }); 
        
        if(currentUser !== 'Admin') {
            let finalY = doc.lastAutoTable.finalY + 10; if (finalY > 240) { doc.addPage(); finalY = 20; } doc.setFillColor(248, 250, 252); doc.setDrawColor(226, 232, 240); doc.roundedRect(14, finalY - 4, 182, 32, 2, 2, 'FD'); doc.setFontSize(9); doc.setFont(undefined, 'bold'); doc.setTextColor(37, 99, 235); doc.text("KONTOSTAND MONATSENDE", 20, finalY + 4); doc.setFontSize(8); doc.setTextColor(30, 41, 59); doc.setFont(undefined, 'normal');
            doc.text(`Monat Soll: ${document.getElementById('sumMonthSoll').innerText} h`, 20, finalY + 12); doc.text(`Monat Ist: ${document.getElementById('sumMonthIst').innerText} h`, 20, finalY + 18); doc.setFont(undefined, 'bold'); doc.text(`STUNDENSALDO: ${balances.totalSaldo.toFixed(2)} h`, 20, finalY + 25); doc.setFont(undefined, 'normal'); doc.text(`Urlaub Anspruch: ${db.admin[currentUser].yearlyVacation} Tage`, 110, finalY + 12); doc.text(`Urlaub Genommen: ${balances.monthVacation} Tage`, 110, finalY + 18); doc.setFont(undefined, 'bold'); doc.setTextColor(21, 128, 61); doc.text(`RESTURLAUB: ${balances.restVacation} Tage`, 110, finalY + 25);
        }
        doc.save(`Zeitnachweis_${currentUser}_${MONTH_NAMES[m]}_${y}.pdf`); 
    } catch (e) { alert("PDF Export fehlgeschlagen: " + e.message); }
}

function exportExcel() {
    const m = parseInt(document.getElementById('viewMonth').value), y = parseInt(document.getElementById('viewYear').value);
    const rows = [["ZEITNACHWEIS", currentUser], ["Monat", MONTH_NAMES[m], y], ["Datum", "Kommen", "Gehen", "Pause", "Ist", "Soll", "Saldo", "Notiz"]];
    for(let i=1; i<=new Date(y, m+1, 0).getDate(); i++) {
        const ds = toLocalISO(new Date(y,m,i)), log = (db.logs[currentUser]||{})[ds] || {};
        const isH = holidaysDB[ds], isWE = new Date(y,m,i).getDay()%6==0, target = (isH || isWE) ? 0 : db.config[currentUser][new Date(y,m,i).getDay()].target;
        let ist = 0, pStr = "-"; let dispOut = log.out || log.type || "";
        if(log.in && log.out) { 
            let calcIn = log.in;
            const cfg = db.config[currentUser][new Date(y,m,i).getDay()] || {start: "00:00"};
            if(!isH && !isWE) calcIn = getKulanzStart(log.in, cfg.start);
            
            let rawIst = ((new Date(ds+"T"+log.out)-new Date(ds+"T"+calcIn))/3600000); 
            if(rawIst > 6.0) { pStr = getBreakTimeRange(ds, log.in, log.out, currentUser); ist = (isH || isWE) ? 0 : rawIst - 0.5; dispOut = getExtendedOutTime(ds, log.in, log.out); } 
            else { ist = (isH || isWE) ? 0 : rawIst; } 
        }
        rows.push([i+"."+(m+1)+".", log.in||"", dispOut, pStr, ist.toFixed(2), target.toFixed(2), (ist-target).toFixed(2), log.note || ""]);
    }
    const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Journal"); XLSX.writeFile(wb, `ZE_${currentUser}.xlsx`);
}
init();
</script>
</body>
</html>
